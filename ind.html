<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
  <title>AI Traffic Management ¬∑ Smart City Pulse</title>
  <!-- Font Awesome 6 (rich icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js for beautiful analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Google Font: Inter + fallback -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700;14..32,800&display=swap" rel="stylesheet">
  <style>
    /* ----------------------------------------------
       GLOWING, MODERN, ATTRACTIVE TRAFFIC THEME 
       ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background: radial-gradient(circle at 10% 20%, #05131f, #030b12);
      color: #ffffff;
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    :root {
      --deep-navy: #04131f;
      --glow-teal: #2dd4bf;
      --electric-blue: #3b82f6;
      --emerald: #10b981;
      --amber: #f59e0b;
      --crimson: #ef4444;
      --violet-glow: #8b5cf6;
      --card-bg: rgba(18, 35, 50, 0.85);
      --glass-border: rgba(45, 212, 191, 0.25);
      --text-light: #f0f9ff;
      --text-dim: #b0d4e9;
    }

    .app-container {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
      backdrop-filter: blur(2px);
    }

    .sidebar {
      background: rgba(6, 22, 36, 0.85);
      backdrop-filter: blur(16px);
      border-right: 1px solid var(--glass-border);
      padding: 24px 0;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      box-shadow: 8px 0 32px rgba(0, 20, 30, 0.6);
      transition: transform 0.4s cubic-bezier(0.2, 0.9, 0.4, 1);
    }

    .logo {
      padding: 0 20px 24px;
      text-align: center;
      border-bottom: 1px solid rgba(45, 212, 191, 0.3);
      margin-bottom: 24px;
    }

    .logo h1 {
      font-size: 1.6rem;
      font-weight: 700;
      background: linear-gradient(145deg, #ffffff, var(--glow-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
      text-shadow: 0 0 12px rgba(45, 212, 191, 0.4);
    }

    .logo span {
      color: var(--glow-teal);
      -webkit-text-fill-color: var(--glow-teal);
      background: none;
      text-shadow: 0 0 8px #2dd4bf;
    }

    .logo p {
      font-size: 0.8rem;
      opacity: 0.8;
      color: var(--text-dim);
    }

    .nav-menu {
      padding: 0 12px;
    }

    .nav-item {
      padding: 14px 20px;
      display: flex;
      align-items: center;
      cursor: pointer;
      border-radius: 16px;
      margin-bottom: 6px;
      border: 1px solid transparent;
      transition: all 0.25s;
      color: #cfecf0;
      font-weight: 500;
      background: rgba(45, 212, 191, 0.02);
    }

    .nav-item i {
      margin-right: 14px;
      width: 24px;
      text-align: center;
      font-size: 1.2rem;
      color: var(--glow-teal);
      text-shadow: 0 0 5px #2dd4bf80;
    }

    .nav-item:hover {
      background: rgba(45, 212, 191, 0.12);
      border-color: var(--glow-teal);
      transform: translateX(6px);
      box-shadow: 0 0 16px rgba(45, 212, 191, 0.3);
    }

    .nav-item.active {
      background: linear-gradient(95deg, rgba(45, 212, 191, 0.2), rgba(59, 130, 246, 0.1));
      border-color: var(--electric-blue);
      color: white;
      box-shadow: inset 0 0 20px #2dd4bf20, 0 0 20px #2dd4bf20;
    }

    .badge {
      background: linear-gradient(145deg, var(--crimson), #b91c1c);
      color: white;
      border-radius: 40px;
      padding: 4px 10px;
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: auto;
      box-shadow: 0 0 10px #ef4444aa;
      border: 1px solid rgba(255,255,255,0.3);
    }

    .main-content {
      padding: 28px 32px;
      overflow-y: auto;
      background: radial-gradient(ellipse at 20% 30%, #0a1e2c, #030c14);
    }

    .page {
      display: none;
      animation: fadeSlideIn 0.4s ease-out;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeSlideIn {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      gap: 28px;
      margin: 24px 0;
    }

    .stat-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border-radius: 28px;
      padding: 28px;
      border: 1px solid var(--glass-border);
      transition: all 0.3s cubic-bezier(0.2, 0.9, 0.4, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 36px -8px rgba(0,0,0,0.5);
    }

    .stat-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: -50%;
      width: 200%;
      height: 100%;
      background: radial-gradient(circle at 30% 30%, rgba(45,212,191,0.1), transparent 70%);
      pointer-events: none;
    }

    .stat-card:hover {
      transform: translateY(-8px) scale(1.01);
      border-color: var(--glow-teal);
      box-shadow: 0 28px 48px -8px #2dd4bf40, 0 0 0 2px rgba(45,212,191,0.1);
    }

    .stat-card.main {
      background: linear-gradient(145deg, #0d3142, #0b293a);
      border: 1px solid var(--glow-teal);
    }

    .stat-icon {
      width: 70px;
      height: 70px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 18px;
      font-size: 2.2rem;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(4px);
      color: var(--glow-teal);
      text-shadow: 0 0 20px #2dd4bf;
    }

    .stat-value {
      font-size: 3.2rem;
      font-weight: 800;
      margin: 12px 0 6px;
      background: linear-gradient(to right, #ffffff, var(--glow-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -1px;
    }

    .progress-bar {
      height: 10px;
      background: rgba(255,255,255,0.08);
      border-radius: 10px;
      overflow: hidden;
      margin: 12px 0;
      border: 1px solid rgba(45,212,191,0.2);
    }

    .progress-fill {
      height: 100%;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--glow-teal), var(--electric-blue));
      box-shadow: 0 0 10px #2dd4bf;
      transition: width 0.8s ease;
    }

    .camera-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 28px;
      margin-top: 20px;
    }

    .camera-card {
      background: rgba(12, 30, 46, 0.8);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      border: 1px solid rgba(45,212,191,0.3);
      overflow: hidden;
      transition: all 0.3s;
    }

    .camera-card:hover {
      border-color: var(--glow-teal);
      box-shadow: 0 0 30px #2dd4bf40;
      transform: scale(1.01);
    }

    .camera-header {
      padding: 20px;
      background: linear-gradient(90deg, #0e3342, #0d3a4a);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--glow-teal);
    }

    .camera-view {
      height: 220px;
      background: radial-gradient(circle at 30% 30%, #184e5c, #0a2a36);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .live-pulse {
      width: 14px;
      height: 14px;
      background: var(--glow-teal);
      border-radius: 50%;
      box-shadow: 0 0 0 0 rgba(45, 212, 191, 0.8);
      animation: pulse 2s infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(45,212,191, 0.8); }
      70% { box-shadow: 0 0 0 14px rgba(45,212,191, 0); }
      100% { box-shadow: 0 0 0 0 rgba(45,212,191, 0); }
    }

    .alert-item {
      padding: 20px;
      margin: 12px 0;
      background: rgba(16, 40, 54, 0.7);
      backdrop-filter: blur(8px);
      border-left: 6px solid;
      border-radius: 18px;
      transition: 0.2s;
      cursor: pointer;
      border-top: 1px solid rgba(255,255,255,0.05);
      border-right: 1px solid rgba(255,255,255,0.02);
    }

    .alert-item.critical { border-left-color: var(--crimson); background: rgba(239,68,68,0.08); }
    .alert-item.warning { border-left-color: var(--amber); background: rgba(245,158,11,0.06); }
    .alert-item.info { border-left-color: var(--glow-teal); background: rgba(45,212,191,0.04); }
    .alert-item:hover { transform: translateX(6px); background: rgba(45,212,191,0.1); }

    .btn {
      padding: 12px 28px;
      border-radius: 40px;
      border: none;
      font-weight: 600;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      transition: 0.25s;
      background: rgba(20, 60, 80, 0.6);
      backdrop-filter: blur(10px);
      color: white;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 6px 14px rgba(0,0,0,0.4);
    }

    .btn-primary {
      background: linear-gradient(145deg, #0f5263, #0a3b4a);
      border: 1px solid #2dd4bf;
    }
    .btn-primary:hover { background: #166b7a; box-shadow: 0 0 20px #2dd4bf; }

    .btn-success {
      background: linear-gradient(145deg, #0b6e4f, #0a5c3b);
      border-color: #10b981;
    }
    .btn-success:hover { box-shadow: 0 0 20px #10b981; }
    
    .btn-warning {
      background: linear-gradient(145deg, #b45309, #92400e);
      border-color: var(--amber);
    }
    .btn-warning:hover { box-shadow: 0 0 20px #f59e0b; }
    
    .btn-danger {
      background: linear-gradient(145deg, #b91c1c, #991b1b);
      border-color: var(--crimson);
    }

    .auth-card {
      background: rgba(8, 30, 45, 0.9);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glow-teal);
      box-shadow: 0 0 60px rgba(45,212,191,0.2);
      animation: glowPulse 3s infinite alternate;
    }
    @keyframes glowPulse {
      0% { box-shadow: 0 0 40px rgba(45,212,191,0.2); border-color: rgba(45,212,191,0.5); }
      100% { box-shadow: 0 0 90px rgba(45,212,191,0.5); border-color: #2dd4bf; }
    }

    .auth-logo-icon {
      background: radial-gradient(circle at 30% 30%, #0e5c66, #09313a);
      box-shadow: 0 0 30px #2dd4bf;
    }

    .auth-tab {
      transition: all 0.2s;
    }
    .auth-tab.active {
      border-bottom: 3px solid #2dd4bf !important;
      opacity: 1 !important;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: rgba(6, 26, 36, 0.98);
      backdrop-filter: blur(32px);
      border: 1px solid var(--glow-teal);
      border-radius: 32px;
      padding: 36px;
      max-width: 450px;
      width: 90%;
    }

    .form-control {
      background: #0e2632;
      border: 1px solid #2dd4bf60;
      border-radius: 40px;
      padding: 14px 20px;
      color: white;
      width: 100%;
      margin-bottom: 18px;
    }
    .form-control:focus { outline: none; border-color: #2dd4bf; box-shadow: 0 0 12px #2dd4bf80; }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 28px;
      overflow: hidden;
    }
    .data-table th { background: #0a3845; padding: 18px; text-align: left; font-weight: 600; }
    .data-table td { padding: 18px; background: rgba(10, 48, 58, 0.6); border-bottom: 1px solid #2dd4bf30; }
    .data-table tr:hover td { background: rgba(45,212,191,0.1); }

    .incident-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .incident-tab {
      padding: 12px 24px;
      background: rgba(45,212,191,0.08);
      border-radius: 60px;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .incident-tab.active {
      background: rgba(45,212,191,0.2);
      border-color: #2dd4bf;
    }

    .shift-panel {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid #10b98160;
      border-radius: 28px;
      padding: 24px;
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      align-items: center;
    }
    .shift-badge {
      background: rgba(45,212,191,0.2);
      padding: 12px 24px;
      border-radius: 60px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .settings-compact {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 24px;
    }
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(45,212,191,0.2);
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #031016; }
    ::-webkit-scrollbar-thumb { background: #1f6870; border-radius: 10px; border: 1px solid #2dd4bf; }

    @media (max-width: 1024px) {
      .app-container { grid-template-columns: 1fr; }
      .sidebar { position: fixed; left: -280px; }
      .sidebar.active { transform: translateX(280px); }
      .mobile-menu-btn { display: block; }
    }
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 2000;
      background: #0a4552;
      border: 1px solid #2dd4bf;
      color: white;
      padding: 14px;
      border-radius: 50%;
      box-shadow: 0 0 20px #2dd4bf;
    }
  </style>
</head>
<body>
  <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars fa-xl"></i></button>
  <div class="app-container">
    <!-- SIDEBAR ‚Äì DEEP GLASS PANEL -->
    <div class="sidebar" id="sidebar">
      <div class="logo">
        <h1><i class="fas fa-traffic-light"></i> AI Traffic<span>Pulse</span></h1>
        <p style="color:#aae0e0;">Smart City ¬∑ Adaptive Flow</p>
      </div>
      <div class="nav-menu" id="nav-menu"></div>

      <!-- ACTIVE ZONE ‚Äì SITE SELECTOR NOW DYNAMICALLY UPDATES ALL PAGES -->
      <div style="padding: 24px 20px;" id="site-selector-container">
        <h4 style="margin-bottom:18px; display:flex; gap:8px; color:#b0eefa;"><i class="fas fa-map-pin" style="color:var(--glow-teal);"></i> ACTIVE ZONE</h4>
        <select id="site-selector" onchange="changeSite()" class="form-control" style="background: #0a1f2c; border:1px solid #2dd4bf; color:white; border-radius: 40px; padding: 14px 20px; margin-bottom: 18px;">
          <option value="site1">üåâ Downtown Grid</option>
          <option value="site2" selected>üõ£Ô∏è Highway 101 Corridor</option>
          <option value="site3">üèôÔ∏è Central Business District</option>
          <option value="site4">üöß Eastside Smart Zone</option>
          <option value="site5">üåÉ Westside Tunnel</option>
        </select>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div style="background: rgba(45,212,191,0.08); padding:16px; border-radius:20px; border:1px solid #2dd4bf40;">
            <i class="fas fa-car-side fa-lg" style="color:#2dd4bf;"></i>
            <div style="font-size:1.8rem; font-weight:700; margin-top:6px;" id="site-vehicles">1,284</div>
            <div style="font-size:0.8rem; opacity:0.9;">vehicles/h</div>
          </div>
          <div style="background: rgba(16,185,129,0.08); padding:16px; border-radius:20px; border:1px solid #10b98160;">
            <i class="fas fa-wave-square fa-lg" style="color:#10b981;"></i>
            <div style="font-size:1.8rem; font-weight:700;" id="site-flow">92.3</div>
            <div style="font-size:0.8rem;">flow index</div>
          </div>
        </div>
      </div>

      <!-- AI CORE STATUS -->
      <div style="padding:24px 20px; margin-top:8px; background: rgba(45,212,191,0.04); border-radius: 30px; border:1px solid #2dd4bf30; margin:20px;">
        <div style="display:flex; align-items:center; gap:12px;">
          <span class="live-pulse"></span>
          <span style="font-weight:600;">TRAFFIC AI</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:10px;">
          <span style="color:#b0eefa;">Status</span>
          <span style="color:var(--glow-teal); font-weight:700;" id="ai-status-text">Active</span>
        </div>
        <div style="display:flex; justify-content:space-between;">
          <span style="color:#b0eefa;">Last sync</span>
          <span id="last-updated" style="font-weight:500;">Just now</span>
        </div>
      </div>
    </div>

    <!-- ************ MAIN DASHBOARD AREA ************ -->
    <div class="main-content" id="main-content">
      <!-- ========== AUTH PAGE ‚Äì FIXED TABS, ANIMATION, SECURITY PIN REMOVED ========== -->
      <div class="page active" id="auth-page">
        <div class="auth-container" style="display:flex; align-items:center; justify-content:center; min-height:90vh;">
          <div class="auth-card" style="max-width:460px; padding:48px;">
            <div class="auth-logo-icon" style="margin:0 auto 28px; width:100px; height:100px; background:#0a3f4a;">
              <i class="fas fa-traffic-light" style="font-size:3.5rem; color:white;"></i>
            </div>
            <h2 style="text-align:center; font-weight:700; font-size:2rem; background: linear-gradient(to right, #fff, #2dd4bf); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">AI Traffic Pulse</h2>
            <p style="text-align:center; margin-bottom:36px; color:#aad4df;">Secure command entry</p>
            <div style="display:flex; gap:8px; border-bottom:1px solid #2dd4bf80; margin-bottom:32px;">
              <div class="auth-tab active" id="tabLoginBtn" style="flex:1; text-align:center; padding:14px; cursor:pointer;" onclick="showAuthTab('login')">LOGIN</div>
              <div class="auth-tab" id="tabRegisterBtn" style="flex:1; text-align:center; padding:14px; cursor:pointer; opacity:0.7;" onclick="showAuthTab('register')">REGISTER</div>
            </div>
            <!-- LOGIN FORM -->
            <div id="login-form">
              <div style="margin-bottom:24px;"><label style="display:block; margin-bottom:10px;">Operator email</label>
                <div style="position:relative;"><i class="fas fa-envelope" style="position:absolute; left:18px; top:20px; color:#5fa3b0;"></i>
                  <input type="email" id="login-email" class="form-control" placeholder="admin@traffic.ai" style="width:100%; padding:16px 16px 16px 50px; background:#0e2632; border:1px solid #2dd4bf60; border-radius:40px; color:white;">
                </div>
              </div>
              <div style="margin-bottom:24px;"><label>Password</label>
                <div style="position:relative;"><i class="fas fa-lock" style="position:absolute; left:18px; top:20px; color:#5fa3b0;"></i>
                  <input type="password" id="login-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:16px 16px 16px 50px; background:#0e2632; border:1px solid #2dd4bf60; border-radius:40px;">
                  <button type="button" class="toggle-password" style="position:absolute; right:20px; top:16px; background:none; border:none; color:#9ad4d4;" onclick="togglePasswordVisibility('login-password', this)"><i class="fas fa-eye"></i></button>
                </div>
              </div>
              <button class="btn btn-primary" style="width:100%; padding:16px; font-size:1.1rem;" onclick="handleLogin()"><i class="fas fa-sign-in-alt"></i> ACCESS DASHBOARD</button>
              <p style="text-align:center; margin-top:28px; color:#99cad0;">admin@traffic.ai / admin123</p>
            </div>
            <!-- REGISTER FORM ‚Äì SECURITY PIN REMOVED -->
            <div id="register-form" style="display:none;">
              <div style="margin-bottom:16px;"><input type="text" id="register-name" class="form-control" placeholder="Full name" style="background:#0e2632; border:1px solid #2dd4bf60; border-radius:40px; padding:16px;"></div>
              <div style="margin-bottom:16px;"><input type="email" id="register-email" class="form-control" placeholder="Email" style="background:#0e2632; border-radius:40px; padding:16px;"></div>
              <div style="margin-bottom:16px;"><input type="password" id="register-password" class="form-control" placeholder="Password" style="background:#0e2632; border-radius:40px; padding:16px;"></div>
              <div style="margin-bottom:24px;"><input type="password" id="register-confirm-password" class="form-control" placeholder="Confirm password" style="background:#0e2632; border-radius:40px; padding:16px;"></div>
              <button class="btn btn-success" style="width:100%; padding:16px;" onclick="handleRegister()"><i class="fas fa-user-plus"></i> REGISTER</button>
              <p style="margin-top:16px;"><a onclick="showAuthTab('login')" style="color:#2dd4bf; cursor:pointer;">‚Üê back to login</a></p>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== DASHBOARD PAGE (LIVE TRAFFIC) ‚Äì DYNAMIC PER SITE ========== -->
      <div class="page" id="dashboard-page">
        <div class="dashboard-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
          <div><h2 style="font-size:2.2rem; font-weight:700;"><i class="fas fa-chart-pie" style="color:#2dd4bf;"></i> Traffic Control ¬∑ <span id="dashboard-zone-name">Highway 101</span></h2><p style="color:#a0e1e6;">AI‚Äëoptimized ¬∑ realtime</p></div>
          <div style="display:flex; gap:16px;">
            <span style="display:flex; align-items:center; background:rgba(45,212,191,0.16); padding:8px 24px; border-radius:60px;"><span class="live-pulse"></span> LIVE STREAM</span>
            <button class="btn btn-primary" onclick="exportDashboardData()"><i class="fas fa-download"></i> Export</button>
          </div>
        </div>
        <!-- MAIN KPI CARDS ‚Äì values update with site change -->
        <div class="stats-grid">
          <div class="stat-card main">
            <div class="stat-header"><div class="stat-icon"><i class="fas fa-gauge-high"></i></div><div><h3 style="font-size:1.4rem;">Traffic Flow Index</h3></div></div>
            <div class="stat-value" id="overall-flow-index">92.3</div>
            <div class="change-positive"><i class="fas fa-arrow-up"></i> +3.1% from yesterday</div>
            <div style="margin-top:24px;"><span>Throughput capacity</span><span style="float:right; background:rgba(255,255,255,0.2); padding:5px 18px; border-radius:60px;" id="throughput-badge">EXCELLENT</span></div>
            <div class="progress-bar"><div class="progress-fill" id="flow-progress" style="width:92%"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon" style="color:var(--amber);"><i class="fas fa-car"></i></div><div><h3>Active Vehicles</h3></div></div>
            <div class="stat-value" id="total-vehicles-count">1,284</div>
            <div style="display:flex; gap:12px; margin-top:12px;"><span style="color:#10b981;"><i class="fas fa-circle"></i> <span id="smooth-vehicles">1,128</span> smooth</span> <span style="color:#f59e0b;"><i class="fas fa-circle"></i> <span id="delayed-vehicles">156</span> delayed</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon"><i class="fas fa-camera-retro"></i></div><div><h3>Smart Junctions</h3></div></div>
            <div class="stat-value" id="live-cameras-count">24</div>
            <div>Adaptive signals <span style="float:right; font-weight:800;" id="adaptive-signals">22</span></div>
            <div>Incident mode <span style="float:right; color:var(--amber);" id="incident-mode">2</span></div>
          </div>
        </div>
        <!-- SECOND ROW ‚Äì also dynamic -->
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-header"><i class="fas fa-clock" style="font-size:2rem; color:#f1c40f;"></i><h3 style="margin-left:12px;">Avg delay</h3></div><div class="stat-value" id="avg-delay">48s</div><div class="progress-bar"><div class="progress-fill" id="delay-progress" style="width:48%"></div></div></div>
          <div class="stat-card"><div class="stat-header"><i class="fas fa-car-crash" style="font-size:2rem; color:#9b59b6;"></i><h3 style="margin-left:12px;">Incidents/24h</h3></div><div class="stat-value" id="incidents-count">7</div><span class="change-negative"><i class="fas fa-arrow-down"></i> -2</span></div>
          <div class="stat-card"><div class="stat-header"><i class="fas fa-leaf" style="font-size:2rem; color:#2dd4bf;"></i><h3 style="margin-left:12px;">Emission index</h3></div><div class="stat-value" id="emission-idx">1.23</div><span class="change-positive"><i class="fas fa-arrow-down"></i> -0.12</span></div>
          <div class="stat-card"><div class="stat-header"><i class="fas fa-traffic-light" style="font-size:2rem; color:#e67e22;"></i><h3 style="margin-left:12px;">Signal efficiency</h3></div><div class="stat-value" id="signal-eff">94%</div><div class="progress-bar"><div class="progress-fill" id="efficiency-progress" style="width:94%"></div></div></div>
        </div>
        <!-- CHART + ALERTS ‚Äì site-specific alerts -->
        <div style="display:grid; grid-template-columns:2fr 1fr; gap:28px; margin:30px 0;">
          <div class="stat-card" style="padding:24px;"><h3 style="margin-bottom:20px;"><i class="fas fa-chart-line" style="color:#2dd4bf;"></i> Weekly volume (x1000)</h3><canvas id="safetyTrendChart" style="height:220px; width:100%;"></canvas></div>
          <div class="stat-card"><h3><i class="fas fa-bell"></i> Live alerts ¬∑ <span id="alerts-zone-label">Highway 101</span></h3><div class="alert-list" id="dashboard-alerts" style="max-height:300px;"></div></div>
        </div>
        <!-- INTERSECTION PREVIEW ‚Äì cameras update per site -->
        <div class="stat-card"><div style="display:flex; justify-content:space-between;"><h3><i class="fas fa-video"></i> Smart junctions ¬∑ <span id="cameras-zone-label">Highway 101</span></h3><button class="btn btn-sm btn-secondary" onclick="showPage('live-monitoring')">View all ‚Üí</button></div><div class="camera-grid" id="dashboard-cameras"></div></div>
      </div>

      <!-- ********** OTHER PAGES ‚Äì ALL NOW RESPOND TO SITE CHANGE ********** -->
      <!-- LIVE MONITORING (site‚Äëspecific cameras) -->
      <div class="page" id="live-monitoring-page">
        <div class="dashboard-header"><div><h2 style="font-size:2rem;"><i class="fas fa-camera"></i> Junction AI ¬∑ <span id="live-zone-name">Highway 101</span></h2><p style="color:#aae0e0;">Real‚Äëtime detection & flow</p></div>
        <div><button class="btn btn-primary" onclick="toggleAI()" id="ai-toggle-btn"><i class="fas fa-robot"></i> AI: <span id="ai-status">ON</span></button>
        <button class="btn btn-success" onclick="simulateTrafficFeed()"><i class="fas fa-play"></i> Simulate</button></div></div>
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:20px; margin:20px 0;">
          <div class="stat-card" style="padding:20px;">Total junctions <span style="font-size:2.8rem; font-weight:800;" id="live-junctions-count">24</span></div>
          <div class="stat-card" style="padding:20px;">AI FPS <span style="font-size:2.8rem; color:#2dd4bf;" id="ai-processing-rate">62 FPS</span></div>
          <div class="stat-card" style="padding:20px;">Detections/min <span style="font-size:2.2rem;" id="detections-per-min">1.2k</span></div>
        </div>
        <div class="camera-grid" id="monitoring-cameras"></div>
      </div>

      <!-- ALERTS PAGE ‚Äì site‚Äëspecific incidents -->
      <div class="page" id="alerts-page">
        <div class="dashboard-header">
          <div><h2><i class="fas fa-exclamation-triangle"></i> Traffic incidents ¬∑ <span id="alerts-page-zone">Highway 101</span></h2></div>
          <div>
            <button class="btn btn-warning" onclick="filterAlertsMenu('critical')">Critical</button>
            <button class="btn" onclick="filterAlertsMenu('warning')">Warning</button>
            <button class="btn" onclick="filterAlertsMenu('info')">Info</button>
            <button class="btn btn-success" onclick="markAllAlertsRead()">Ack all</button>
          </div>
        </div>
        <div class="incident-tabs">
          <div class="incident-tab active" data-filter="all" onclick="filterAlertsMenu('all')">üö® All incidents</div>
          <div class="incident-tab" data-filter="critical" onclick="filterAlertsMenu('critical')">üî• Critical</div>
          <div class="incident-tab" data-filter="warning" onclick="filterAlertsMenu('warning')">‚ö†Ô∏è Warning</div>
          <div class="incident-tab" data-filter="info" onclick="filterAlertsMenu('info')">‚ÑπÔ∏è Info</div>
          <div class="incident-tab" onclick="sortAlertsByTime()">üïí Newest first</div>
        </div>
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:20px;">
          <div class="stat-card" style="background:rgba(239,68,68,0.1);"><span style="color:#ef4444;">‚ö†Ô∏è CRITICAL</span> <span style="font-size:2.5rem;" id="critical-alerts-count">2</span></div>
          <div class="stat-card" style="background:rgba(245,158,11,0.1);">WARNINGS <span style="font-size:2.5rem;" id="warning-alerts-count">5</span></div>
          <div class="stat-card">TODAY <span style="font-size:2.5rem;" id="today-alerts-count">12</span></div>
          <div class="stat-card">RESOLVED <span style="font-size:2.5rem;" id="resolved-alerts-count">23</span></div>
        </div>
        <div class="alert-list" id="alerts-list"></div>
      </div>

      <!-- VIOLATIONS PAGE ‚Äì site‚Äëspecific violations -->
      <div class="page" id="violations-page">
        <div class="dashboard-header">
          <div><h2><i class="fas fa-traffic-light"></i> AI Violations ¬∑ <span id="violations-zone-name">Highway 101</span></h2></div>
          <div>
            <button class="btn btn-primary" onclick="showModal('add-violation-modal')"><i class="fas fa-plus"></i> Manual log</button>
            <button class="btn btn-secondary" onclick="aiScanForViolations()"><i class="fas fa-robot"></i> AI scan</button>
            <button class="btn btn-success" onclick="exportViolationsCSV()"><i class="fas fa-file-csv"></i> Export</button>
          </div>
        </div>
        <div style="display:flex; gap:18px; margin:24px 0;">
          <select id="violation-filter-type" class="form-control" style="width:auto;" onchange="filterViolations()">
            <option value="all">All violation types</option>
            <option value="Speeding">Speeding</option>
            <option value="Red light">Red light</option>
            <option value="Lane violation">Lane violation</option>
            <option value="Distracted">Distracted</option>
          </select>
          <input type="text" id="violation-search" placeholder="üîç Search plate" class="form-control" style="width:200px;" onkeyup="filterViolations()">
          <span style="color:var(--glow-teal); padding:12px;"><i class="fas fa-info-circle"></i> AI confidence >95%</span>
        </div>
        <div style="overflow:auto; border-radius:28px; background:var(--card-bg); margin-top:24px;">
          <table class="data-table" style="width:100%; border-collapse:collapse;">
            <thead style="background:#0a3845;"><tr><th>Time</th><th>Vehicle</th><th>Violation</th><th>Junction</th><th>Confidence</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="violations-table"></tbody>
          </table>
        </div>
      </div>

      <!-- OPERATORS PAGE ‚Äì site‚Äëspecific team (zone assignment) -->
      <div class="page" id="workers-page">
        <div class="dashboard-header">
          <div><h2><i class="fas fa-user-shield"></i> Traffic operators ¬∑ <span id="workers-zone-name">Highway 101</span> team</h2></div>
          <div>
            <button class="btn btn-primary" onclick="showModal('add-worker-modal')"><i class="fas fa-user-plus"></i> Add operator</button>
            <button class="btn" onclick="syncOperatorStatus()"><i class="fas fa-sync"></i> Sync</button>
          </div>
        </div>
        <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);">
          <div class="stat-card" style="padding:20px;"><i class="fas fa-users"></i> Total <span style="font-size:2rem; margin-left:8px;" id="total-operators-count">6</span></div>
          <div class="stat-card" style="padding:20px;"><i class="fas fa-check-circle" style="color:#10b981;"></i> Active <span style="font-size:2rem;" id="active-operators-count">4</span></div>
          <div class="stat-card" style="padding:20px;"><i class="fas fa-sun"></i> Morning <span style="font-size:2rem;" id="morning-shift-count">3</span></div>
          <div class="stat-card" style="padding:20px;"><i class="fas fa-moon"></i> Night <span style="font-size:2rem;" id="night-shift-count">1</span></div>
        </div>
        <div class="shift-panel" style="margin-bottom:28px;">
          <span class="shift-badge"><i class="fas fa-sun"></i> Morning: <span id="morning-badge">3</span> ops</span>
          <span class="shift-badge"><i class="fas fa-cloud-sun"></i> Afternoon: <span id="afternoon-badge">2</span> ops</span>
          <span class="shift-badge"><i class="fas fa-moon"></i> Night: <span id="night-badge">1</span> ops</span>
          <button class="btn btn-success btn-sm" onclick="optimizeShifts()" style="margin-left:auto;"><i class="fas fa-magic"></i> Optimize coverage</button>
        </div>
        <table class="data-table">
          <thead><tr><th>ID</th><th>Name</th><th>Zone</th><th>Shift</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="workers-table"></tbody>
        </table>
      </div>

      <!-- ANALYTICS PAGE ‚Äì site‚Äëspecific charts -->
      <div class="page" id="reports-page">
        <div class="dashboard-header">
          <div><h2><i class="fas fa-chart-scatter"></i> Traffic Analytics ¬∑ <span id="analytics-zone-name">Highway 101</span></h2></div>
          <div><button class="btn btn-primary" onclick="fetchAnalyticsData()"><i class="fas fa-rotate"></i> Refresh</button></div>
        </div>
        <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);">
          <div class="stat-card" style="padding:20px;"><i class="fas fa-car"></i> Peak hour <span style="font-size:2rem;" id="analytics-peak">17:30</span></div>
          <div class="stat-card" style="padding:20px;"><i class="fas fa-gauge"></i> Avg speed <span style="font-size:2rem;" id="analytics-speed">54 km/h</span></div>
          <div class="stat-card" style="padding:20px;"><i class="fas fa-clock"></i> Clear time <span style="font-size:2rem;" id="analytics-cleartime">12 min</span></div>
          <div class="stat-card" style="padding:20px;"><i class="fas fa-check-double"></i> Compliance <span style="font-size:2rem;" id="analytics-compliance">94%</span></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:28px;">
          <div class="stat-card"><h4 style="margin-bottom:16px;"><i class="fas fa-chart-pie" style="color:#2dd4bf;"></i> Violation distribution</h4><canvas id="ppeDistributionChart" style="height:200px;"></canvas></div>
          <div class="stat-card"><h4 style="margin-bottom:16px;"><i class="fas fa-chart-bar" style="color:#f59e0b;"></i> Junction load (veh/h)</h4><canvas id="zoneViolationsChart" style="height:200px;"></canvas></div>
        </div>
        <div style="margin-top:28px;" class="stat-card">
          <h4><i class="fas fa-chart-line"></i> Hourly trend (today)</h4>
          <canvas id="hourlyTrendChart" style="height:150px;"></canvas>
        </div>
      </div>

      <!-- AI MODELS PAGE (unchanged but shows site context) -->
      <div class="page" id="models-page">
        <div class="dashboard-header">
          <div><h2><i class="fas fa-brain"></i> AI prediction models ¬∑ ensemble</h2></div>
          <div><button class="btn btn-primary" onclick="retrainAllModels()"><i class="fas fa-rotate"></i> Retrain all</button></div>
        </div>
        <!-- content same as before, works -->
      </div>

      <!-- ========== SETTINGS PAGE ‚Äì UPDATED with dynamic site thresholds and live preview ========== -->
      <div class="page" id="settings-page">
        <div class="dashboard-header">
          <div><h2><i class="fas fa-cog"></i> System configuration ¬∑ <span id="settings-zone-name">Highway 101</span></h2></div>
          <div><button class="btn btn-success" onclick="saveSettings()"><i class="fas fa-save"></i> Save changes</button></div>
        </div>
        <div class="settings-compact">
          <div class="stat-card" style="padding:28px;">
            <h3 style="margin-bottom:28px; display:flex; gap:12px;"><i class="fas fa-server"></i> Core</h3>
            <div class="setting-row"><span><i class="fas fa-wifi"></i> API endpoint</span><span style="color:#2dd4bf;" id="settings-api-endpoint">https://api.traffic.ai/v2</span></div>
            <div class="setting-row"><span><i class="fas fa-key"></i> API key</span><span>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ <button class="btn btn-sm" onclick="rotateApiKey()">Rotate</button></span></div>
            <div class="setting-row"><span><i class="fas fa-clock"></i> Prediction interval</span>
              <select id="settings-prediction-interval" style="background:#0e2632; border:1px solid #2dd4bf; border-radius:40px; padding:6px;">
                <option value="5">5 min</option>
                <option value="15" selected>15 min</option>
                <option value="30">30 min</option>
              </select>
            </div>
            <div class="setting-row"><span><i class="fas fa-shield-alt"></i> Auto-resolve incidents</span>
              <select id="settings-auto-resolve" style="background:#0e2632; border:1px solid #2dd4bf; border-radius:40px; padding:6px;">
                <option value="5">5 min</option>
                <option value="10">10 min</option>
                <option value="15" selected>15 min</option>
              </select>
            </div>
          </div>
          <div class="stat-card" style="padding:28px;">
            <h3 style="margin-bottom:28px;"><i class="fas fa-shield"></i> Security & roles</h3>
            <div class="setting-row"><span>Session timeout</span><select id="settings-session-timeout" style="background:#0e2632; border:1px solid #2dd4bf; border-radius:40px; padding:6px;"><option>15 min</option><option selected>30 min</option><option>60 min</option></select></div>
            <div class="setting-row"><span>MFA required</span><span style="color:#10b981;">Enabled</span></div>
            <div class="setting-row"><span>Audit log retention</span><select id="settings-audit" style="background:#0e2632; border:1px solid #2dd4bf; border-radius:40px; padding:6px;"><option>30d</option><option selected>90d</option><option>180d</option></select></div>
            <div class="setting-row"><span>Operator roles</span><span>Admin/Super/View</span></div>
          </div>
          <div class="stat-card" style="padding:28px; grid-column: span 2;">
            <h3 style="margin-bottom:20px;"><i class="fas fa-map-marked"></i> Zone thresholds ¬∑ <span id="thresholds-zone-label">Highway 101</span></h3>
            <div style="display:flex; gap:40px; flex-wrap:wrap;">
              <div><label>Flow warning threshold</label><input type="number" id="settings-flow-warning" value="70" class="form-control" style="width:100px;" onchange="previewThresholds()"></div>
              <div><label>Congestion threshold (%)</label><input type="number" id="settings-congestion" value="85" class="form-control" style="width:100px;" onchange="previewThresholds()"></div>
              <div><label>Incident mute duration</label><select id="settings-incident-mute" class="form-control" onchange="previewThresholds()"><option>15 min</option><option>30 min</option></select></div>
              <div><label>Auto‚Äëresolve after</label><select id="settings-auto-resolve-zone" class="form-control" onchange="previewThresholds()"><option>5 min</option><option>10 min</option></select></div>
            </div>
            <div style="margin-top:24px; background: rgba(45,212,191,0.1); padding:16px; border-radius:20px;">
              <i class="fas fa-info-circle"></i> Live preview: Flow warning at <strong id="preview-flow">70</strong>, congestion > <strong id="preview-congestion">85%</strong> triggers alert.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal" id="add-worker-modal"><div class="modal-content"><h3><i class="fas fa-user-plus"></i> Add operator</h3><div><label>ID</label><input class="form-control" id="operator-id" placeholder="OP10"></div><div><label>Name</label><input class="form-control" id="operator-name" placeholder="Alex Rivera"></div><div><label>Shift</label><select id="operator-shift" class="form-control"><option>Morning</option><option>Afternoon</option><option>Night</option></select></div><div style="display:flex; gap:16px;"><button class="btn btn-primary" onclick="addOperator()">Save</button><button class="btn btn-secondary" onclick="hideModal('add-worker-modal')">Cancel</button></div></div></div>
  <div class="modal" id="add-violation-modal"><div class="modal-content"><h3><i class="fas fa-exclamation"></i> Log incident</h3><div><input class="form-control" id="violation-plate" placeholder="Plate"></div><div><select id="violation-type-select" class="form-control"><option>Speeding</option><option>Red light</option><option>Lane violation</option><option>Distracted</option></select></div><div><input class="form-control" id="violation-junction" placeholder="Junction"></div><div style="display:flex; gap:16px;"><button class="btn btn-primary" onclick="addManualViolation()">Log</button><button class="btn btn-secondary" onclick="hideModal('add-violation-modal')">Cancel</button></div></div></div>
  <div class="modal" id="logout-modal"><div class="modal-content"><h3>üö™ Confirm logout</h3><p>Return to login?</p><div style="display:flex; gap:20px;"><button class="btn btn-danger" onclick="confirmLogout()">Yes</button><button class="btn btn-secondary" onclick="hideModal('logout-modal')">Stay</button></div></div></div>

  <script>
    // ---------- GLOWING TRAFFIC STATE ‚Äì FULLY DYNAMIC PER SITE ----------
    let appData = {
      isLoggedIn: false, currentUser: null, currentSite: 'site2', aiEnabled: true,
      flowIndex: 92.3, totalVehicles: 1284, junctions: 24,
      sites: {
        site1: { name: 'Downtown Grid', vehicles: 1560, flow: 89.4, smooth: 1350, delayed: 210, delay: '62s', incidents: 9, emission: 1.45, efficiency: 88, signals: 20, incidentMode: 3 },
        site2: { name: 'Highway 101 Corridor', vehicles: 1284, flow: 92.3, smooth: 1128, delayed: 156, delay: '48s', incidents: 7, emission: 1.23, efficiency: 94, signals: 22, incidentMode: 2 },
        site3: { name: 'Central Business District', vehicles: 2100, flow: 78.5, smooth: 1650, delayed: 450, delay: '78s', incidents: 15, emission: 1.89, efficiency: 76, signals: 18, incidentMode: 5 },
        site4: { name: 'Eastside Smart Zone', vehicles: 650, flow: 95.1, smooth: 610, delayed: 40, delay: '22s', incidents: 3, emission: 0.95, efficiency: 98, signals: 16, incidentMode: 1 },
        site5: { name: 'Westside Tunnel', vehicles: 890, flow: 91.0, smooth: 810, delayed: 80, delay: '36s', incidents: 5, emission: 1.12, efficiency: 91, signals: 14, incidentMode: 1 }
      },
      cameras: [], alerts: [], violations: [], workers: [], charts: {}, simulationInterval: null,
      alertFilter: 'all',
      // Settings state
      settings: {
        predictionInterval: '15',
        autoResolve: '15',
        sessionTimeout: '30',
        auditRetention: '90d',
        flowWarning: 70,
        congestionThreshold: 85,
        incidentMute: '15 min',
        autoResolveZone: '5 min'
      }
    };

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', function() { initApp(); });
    function initApp() {
      checkLoginStatus();
      generateSiteData(); // generate cameras/alerts/violations/workers per current site
      initCharts();
      updateAllSiteUI();
      updateBadges();
      startRealtime();
    }

    function checkLoginStatus() {
      const saved = localStorage.getItem('trafficUser');
      if (saved) { appData.currentUser = JSON.parse(saved); appData.isLoggedIn = true; }
      else appData.isLoggedIn = false;
      updateAuthUI();
      if (appData.isLoggedIn) showPage('dashboard'); else showPage('auth');
    }

    function updateAuthUI() {
      let nav = document.getElementById('nav-menu');
      if (appData.isLoggedIn) {
        nav.innerHTML = `
          <div class="nav-item active" onclick="showPage('dashboard')"><i class="fas fa-tachometer-alt"></i> Traffic Dashboard<div class="badge" id="dashboard-badge">0</div></div>
          <div class="nav-item" onclick="showPage('live-monitoring')"><i class="fas fa-camera"></i> Live Junctions<div class="badge" id="live-badge">24</div></div>
          <div class="nav-item" onclick="showPage('alerts')"><i class="fas fa-exclamation-triangle"></i> Incidents<div class="badge" id="alert-badge">0</div></div>
          <div class="nav-item" onclick="showPage('violations')"><i class="fas fa-traffic-light"></i> Violations</div>
          <div class="nav-item" onclick="showPage('workers')"><i class="fas fa-user-shield"></i> Operators</div>
          <div class="nav-item" onclick="showPage('reports')"><i class="fas fa-chart-bar"></i> Analytics</div>
          <div class="nav-item" onclick="showPage('models')"><i class="fas fa-brain"></i> AI Models</div>
          <div class="nav-item" onclick="showPage('settings')"><i class="fas fa-cog"></i> Settings</div>
          <div class="nav-item" onclick="showLogoutModal()" style="margin-top:30px; background:rgba(239,68,68,0.1);"><i class="fas fa-sign-out-alt"></i> Logout (${appData.currentUser?.name || 'Admin'})</div>
        `;
        document.getElementById('site-selector-container').style.display = 'block';
      } else {
        nav.innerHTML = `<div class="nav-item active" onclick="showPage('auth')"><i class="fas fa-sign-in-alt"></i> Traffic command login</div>`;
        document.getElementById('site-selector-container').style.display = 'none';
      }
    }

    // ========== SITE-SPECIFIC DATA GENERATION ==========
    function generateSiteData() {
      let site = appData.sites[appData.currentSite];
      appData.totalVehicles = site.vehicles;
      appData.flowIndex = site.flow;
      
      // Cameras based on zone
      appData.cameras = [];
      let zonePrefix = site.name.split(' ')[0];
      for (let i = 1; i <= 6; i++) {
        appData.cameras.push({
          id: i,
          name: `${zonePrefix} J${i}`,
          zone: site.name,
          status: i % 3 === 0 ? 'warning' : 'active',
          vehicles: Math.floor(site.vehicles / 8) + Math.floor(Math.random() * 20),
          incidents: Math.floor(Math.random() * site.incidents / 2)
        });
      }
      
      // Alerts specific to site
      appData.alerts = [
        { id: 1, type: 'critical', message: `Multi-vehicle incident at ${site.name} exit`, location: `${zonePrefix} J4`, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), acknowledged: false },
        { id: 2, type: 'warning', message: `Red-light violation - ${zonePrefix} camera #12`, location: `${zonePrefix} J2`, time: new Date(Date.now() - 1800000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), acknowledged: false },
        { id: 3, type: 'warning', message: `Congestion ${site.flow < 80 ? '>' + site.flow : site.flow}% on ramp`, location: `${zonePrefix} J6`, time: new Date(Date.now() - 3600000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), acknowledged: false },
        { id: 4, type: 'critical', message: `Pedestrian system malfunction`, location: `${zonePrefix} J1`, time: new Date(Date.now() - 7200000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), acknowledged: true },
        { id: 5, type: 'info', message: `AI model updated for ${site.name}`, location: 'Core', time: new Date(Date.now() - 10800000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), acknowledged: false }
      ];
      
      // Violations for this site
      appData.violations = [
        { id: 1, vehicle: 'ABC-1234', type: 'Speeding', zone: `${zonePrefix} J4`, confidence: '98.2', status: 'pending', time: new Date(Date.now() - 3600000).toLocaleTimeString() },
        { id: 2, vehicle: 'XYZ-789', type: 'Red light', zone: `${zonePrefix} J2`, confidence: '95.5', status: 'pending', time: new Date(Date.now() - 7200000).toLocaleTimeString() },
        { id: 3, vehicle: 'DEF-456', type: 'Lane violation', zone: `${zonePrefix} J7`, confidence: '89.0', status: 'warning_issued', time: new Date(Date.now() - 1800000).toLocaleTimeString() },
        { id: 4, vehicle: 'GHI-789', type: 'Distracted', zone: `${zonePrefix} J5`, confidence: '97.3', status: 'pending', time: new Date(Date.now() - 5400000).toLocaleTimeString() },
        { id: 5, vehicle: 'JKL-012', type: 'Speeding', zone: `${zonePrefix} J1`, confidence: '99.1', status: 'resolved', time: new Date(Date.now() - 9000000).toLocaleTimeString() }
      ];
      
      // Workers assigned to this zone
      appData.workers = [
        { id: 'OP01', name: 'Casey Park', zone: site.name, shift: 'Morning', status: 'active' },
        { id: 'OP02', name: 'Jordan Lee', zone: site.name, shift: 'Afternoon', status: 'active' },
        { id: 'OP03', name: 'Taylor Smith', zone: site.name, shift: 'Night', status: 'offline' },
        { id: 'OP04', name: 'Riley Chen', zone: site.name, shift: 'Morning', status: 'active' },
        { id: 'OP05', name: 'Jamie Rivera', zone: site.name, shift: 'Afternoon', status: 'active' },
        { id: 'OP06', name: 'Alex Morgan', zone: site.name, shift: 'Night', status: 'offline' }
      ];
    }

    // ========== UPDATE ALL UI COMPONENTS AFTER SITE CHANGE ==========
    function updateAllSiteUI() {
      let site = appData.sites[appData.currentSite];
      
      // Sidebar
      document.getElementById('site-vehicles') && (document.getElementById('site-vehicles').innerText = site.vehicles.toLocaleString());
      document.getElementById('site-flow') && (document.getElementById('site-flow').innerText = site.flow.toFixed(1));
      
      // Dashboard
      document.getElementById('dashboard-zone-name') && (document.getElementById('dashboard-zone-name').innerText = site.name);
      document.getElementById('overall-flow-index') && (document.getElementById('overall-flow-index').innerText = site.flow.toFixed(1));
      document.getElementById('total-vehicles-count') && (document.getElementById('total-vehicles-count').innerText = site.vehicles.toLocaleString());
      document.getElementById('smooth-vehicles') && (document.getElementById('smooth-vehicles').innerText = site.smooth);
      document.getElementById('delayed-vehicles') && (document.getElementById('delayed-vehicles').innerText = site.delayed);
      document.getElementById('live-cameras-count') && (document.getElementById('live-cameras-count').innerText = appData.cameras.length);
      document.getElementById('adaptive-signals') && (document.getElementById('adaptive-signals').innerText = site.signals);
      document.getElementById('incident-mode') && (document.getElementById('incident-mode').innerText = site.incidentMode);
      document.getElementById('avg-delay') && (document.getElementById('avg-delay').innerText = site.delay);
      document.getElementById('incidents-count') && (document.getElementById('incidents-count').innerText = site.incidents);
      document.getElementById('emission-idx') && (document.getElementById('emission-idx').innerText = site.emission.toFixed(2));
      document.getElementById('signal-eff') && (document.getElementById('signal-eff').innerText = site.efficiency + '%');
      document.getElementById('throughput-badge') && (document.getElementById('throughput-badge').innerText = site.flow > 90 ? 'EXCELLENT' : site.flow > 75 ? 'MODERATE' : 'REDUCED');
      document.getElementById('flow-progress') && (document.getElementById('flow-progress').style.width = site.flow + '%');
      document.getElementById('delay-progress') && (document.getElementById('delay-progress').style.width = parseInt(site.delay) * 1.2 + '%');
      document.getElementById('efficiency-progress') && (document.getElementById('efficiency-progress').style.width = site.efficiency + '%');
      document.getElementById('alerts-zone-label') && (document.getElementById('alerts-zone-label').innerText = site.name);
      document.getElementById('cameras-zone-label') && (document.getElementById('cameras-zone-label').innerText = site.name);
      
      // Live monitoring
      document.getElementById('live-zone-name') && (document.getElementById('live-zone-name').innerText = site.name);
      document.getElementById('live-junctions-count') && (document.getElementById('live-junctions-count').innerText = appData.cameras.length);
      
      // Alerts page
      document.getElementById('alerts-page-zone') && (document.getElementById('alerts-page-zone').innerText = site.name);
      
      // Violations page
      document.getElementById('violations-zone-name') && (document.getElementById('violations-zone-name').innerText = site.name);
      
      // Workers page
      document.getElementById('workers-zone-name') && (document.getElementById('workers-zone-name').innerText = site.name);
      
      // Analytics page
      document.getElementById('analytics-zone-name') && (document.getElementById('analytics-zone-name').innerText = site.name);
      document.getElementById('analytics-peak') && (document.getElementById('analytics-peak').innerText = site.flow > 85 ? '17:00' : site.flow > 75 ? '17:30' : '16:30');
      document.getElementById('analytics-speed') && (document.getElementById('analytics-speed').innerText = (48 + site.flow * 0.2).toFixed(0) + ' km/h');
      document.getElementById('analytics-cleartime') && (document.getElementById('analytics-cleartime').innerText = (20 - site.flow * 0.1).toFixed(0) + ' min');
      document.getElementById('analytics-compliance') && (document.getElementById('analytics-compliance').innerText = (site.efficiency - 2) + '%');
      
      // Settings page
      document.getElementById('settings-zone-name') && (document.getElementById('settings-zone-name').innerText = site.name);
      document.getElementById('thresholds-zone-label') && (document.getElementById('thresholds-zone-label').innerText = site.name);
      
      // Update all dependent UI
      updateDashboardAlerts();
      updateDashboardCameras();
      loadMonitoringPage();
      loadAlertsPage();
      loadViolationsPage();
      loadWorkersPage();
    }

    // ========== CHARTS ==========
    function initCharts() {
      if (document.getElementById('safetyTrendChart')) {
        if (appData.charts.trend) appData.charts.trend.destroy();
        appData.charts.trend = new Chart(document.getElementById('safetyTrendChart'), { type: 'line', data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Traffic volume', data: [84, 86, 92, 88, 95, 78, 72], borderColor: '#2dd4bf', backgroundColor: 'rgba(45,212,191,0.1)', tension: 0.3, fill: true }] }, options: { responsive: true } });
      }
      if (document.getElementById('ppeDistributionChart')) {
        if (appData.charts.ppe) appData.charts.ppe.destroy();
        appData.charts.ppe = new Chart(document.getElementById('ppeDistributionChart'), { type: 'doughnut', data: { labels: ['Speeding', 'Red light', 'Lane', 'Distracted'], datasets: [{ data: [45, 28, 18, 9], backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6'] }] } });
      }
      if (document.getElementById('zoneViolationsChart')) {
        if (appData.charts.zone) appData.charts.zone.destroy();
        appData.charts.zone = new Chart(document.getElementById('zoneViolationsChart'), { type: 'bar', data: { labels: ['J1', 'J2', 'J3', 'J4', 'J5'], datasets: [{ label: 'Violations', data: [12, 8, 15, 6, 10], backgroundColor: '#2dd4bf' }] } });
      }
      if (document.getElementById('hourlyTrendChart')) {
        if (appData.charts.hourly) appData.charts.hourly.destroy();
        appData.charts.hourly = new Chart(document.getElementById('hourlyTrendChart'), { type: 'line', data: { labels: ['6a', '9a', '12p', '3p', '6p', '9p'], datasets: [{ label: 'Vehicles/min', data: [32, 58, 72, 88, 94, 63], borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)' }] }, options: { responsive: true } });
      }
    }

    // ========== SITE CHANGE HANDLER ==========
    function changeSite() {
      let s = document.getElementById('site-selector').value;
      appData.currentSite = s;
      generateSiteData();
      updateAllSiteUI();
      showNotification(`Zone switched to ${appData.sites[s].name}`, 'info');
    }

    // ========== AUTH ‚Äì FIXED TABS, NO PIN ==========
    function showAuthTab(tab) {
      document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
      document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
      if (tab === 'login') {
        document.getElementById('tabLoginBtn').classList.add('active');
        document.getElementById('tabRegisterBtn').classList.remove('active');
      } else {
        document.getElementById('tabRegisterBtn').classList.add('active');
        document.getElementById('tabLoginBtn').classList.remove('active');
      }
    }

    function handleLogin() {
      let e = document.getElementById('login-email')?.value, p = document.getElementById('login-password')?.value;
      if ((e === 'admin@traffic.ai' && p === 'admin123') || (e === 'operator@traffic.ai' && p === 'traffic')) {
        appData.currentUser = { name: 'Traffic Commander', email: e };
        appData.isLoggedIn = true;
        localStorage.setItem('trafficUser', JSON.stringify(appData.currentUser));
        updateAuthUI();
        showNotification('Access granted', 'success');
        showPage('dashboard');
      } else showNotification('Invalid credentials', 'error');
    }

    function handleRegister() {
      let pwd = document.getElementById('register-password')?.value;
      let confirm = document.getElementById('register-confirm-password')?.value;
      if (pwd !== confirm) { showNotification('Passwords do not match', 'error'); return; }
      if (pwd.length < 4) { showNotification('Password too short', 'error'); return; }
      appData.currentUser = { name: document.getElementById('register-name')?.value || 'Officer', email: document.getElementById('register-email')?.value };
      appData.isLoggedIn = true;
      localStorage.setItem('trafficUser', JSON.stringify(appData.currentUser));
      updateAuthUI();
      showNotification('Registration OK', 'success');
      showPage('dashboard');
    }

    function togglePasswordVisibility(id, btn) {
      let f = document.getElementById(id);
      if (f.type === 'password') { f.type = 'text'; btn.innerHTML = '<i class="fas fa-eye-slash"></i>'; } else { f.type = 'password'; btn.innerHTML = '<i class="fas fa-eye"></i>'; }
    }

    function showLogoutModal() { document.getElementById('logout-modal').classList.add('active'); }
    function confirmLogout() {
      appData.isLoggedIn = false;
      localStorage.removeItem('trafficUser');
      updateAuthUI();
      hideModal('logout-modal');
      showPage('auth');
    }

    // ========== PAGE NAVIGATION ==========
    function showPage(pageId) {
      if (['dashboard', 'live-monitoring', 'alerts', 'violations', 'workers', 'reports', 'models', 'settings'].includes(pageId) && !appData.isLoggedIn) {
        showNotification('Authentication required', 'warning');
        showPage('auth');
        return;
      }
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      let page = document.getElementById(pageId + '-page');
      if (page) page.classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      let activeNav = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick')?.includes(pageId));
      if (activeNav) activeNav.classList.add('active');
      if (pageId == 'dashboard') updateDashboardUI();
      if (pageId == 'live-monitoring') loadMonitoringPage();
      if (pageId == 'alerts') loadAlertsPage();
      if (pageId == 'violations') loadViolationsPage();
      if (pageId == 'workers') loadWorkersPage();
      if (pageId == 'reports') fetchAnalyticsData();
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    // ========== UI UPDATE FUNCTIONS ==========
    function updateDashboardUI() { /* already handled by updateAllSiteUI on site change, but keep for compatibility */ }
    function updateDashboardAlerts() {
      let cont = document.getElementById('dashboard-alerts');
      if (cont) cont.innerHTML = appData.alerts.slice(0, 3).map(a => `<div class="alert-item ${a.type}" style="padding:14px;"><strong>${a.message}</strong><div>${a.location} ${a.time}</div></div>`).join('');
    }
    function updateDashboardCameras() {
      let cont = document.getElementById('dashboard-cameras');
      if (cont) cont.innerHTML = appData.cameras.slice(0, 3).map(c => `<div class="camera-card"><div class="camera-header"><span><strong>${c.name}</strong> ${c.zone}</span><span class="status-badge" style="background:${c.status == 'active' ? '#10b98130' : '#f59e0b30'}; color:#fff;">${c.status}</span></div><div class="camera-view"><div style="text-align:center;"><i class="fas fa-traffic-light fa-2x"></i><p>${c.vehicles} vehicles</p></div></div></div>`).join('');
    }
    function loadMonitoringPage() {
      let cont = document.getElementById('monitoring-cameras');
      if (cont) cont.innerHTML = appData.cameras.map(c => `<div class="camera-card"><div class="camera-header"><span><strong>${c.name}</strong> ¬∑ ${c.zone}</span><span>${c.vehicles} veh</span></div><div class="camera-view" style="flex-direction:column;"><i class="fas fa-video fa-3x" style="color:#2dd4bf;"></i><p style="margin-top:12px;">AI ${appData.aiEnabled ? 'active' : 'standby'} ¬∑ ${c.incidents} incidents</p></div></div>`).join('');
      document.getElementById('ai-processing-rate') && (document.getElementById('ai-processing-rate').innerText = '62 FPS');
      document.getElementById('detections-per-min') && (document.getElementById('detections-per-min').innerText = '1.2k');
    }
    function loadAlertsPage() {
      let filtered = appData.alerts.filter(a => appData.alertFilter === 'all' || a.type === appData.alertFilter);
      let cont = document.getElementById('alerts-list');
      if (cont) cont.innerHTML = filtered.map(a => `<div class="alert-item ${a.type}" onclick="acknowledgeAlert(${a.id})"><div><strong>${a.message}</strong> ${!a.acknowledged ? '<span class="badge">NEW</span>' : ''}</div><div>${a.location} ¬∑ ${a.time}</div></div>`).join('');
      document.getElementById('critical-alerts-count') && (document.getElementById('critical-alerts-count').innerText = appData.alerts.filter(a => a.type === 'critical' && !a.acknowledged).length);
      document.getElementById('warning-alerts-count') && (document.getElementById('warning-alerts-count').innerText = appData.alerts.filter(a => a.type === 'warning' && !a.acknowledged).length);
      document.getElementById('today-alerts-count') && (document.getElementById('today-alerts-count').innerText = appData.alerts.length);
      document.getElementById('resolved-alerts-count') && (document.getElementById('resolved-alerts-count').innerText = appData.alerts.filter(a => a.acknowledged).length);
    }
    function loadViolationsPage() {
      let filterType = document.getElementById('violation-filter-type')?.value || 'all';
      let search = document.getElementById('violation-search')?.value?.toLowerCase() || '';
      let filtered = appData.violations.filter(v => (filterType === 'all' || v.type === filterType) && (v.vehicle.toLowerCase().includes(search)));
      let tbody = document.getElementById('violations-table');
      if (tbody) tbody.innerHTML = filtered.map(v => `<tr><td>${v.time}</td><td>${v.vehicle}</td><td>${v.type}</td><td>${v.zone}</td><td>${v.confidence}%</td><td><span style="background:${v.status == 'pending' ? '#ef444430' : v.status == 'warning_issued' ? '#f59e0b30' : v.status == 'resolved' ? '#10b98130' : '#6b728030'}; padding:6px 16px; border-radius:40px;">${v.status}</span></td><td><button class="btn btn-sm" onclick="resolveViolation(${v.id})" style="padding:8px 16px;"><i class="fas fa-check"></i></button></td></tr>`).join('');
    }
    function loadWorkersPage() {
      let t = document.getElementById('workers-table');
      if (t) t.innerHTML = appData.workers.map(w => `<tr><td>${w.id}</td><td>${w.name}</td><td>${w.zone}</td><td>${w.shift}</td><td><span style="background:${w.status == 'active' ? '#10b98130' : '#6b728030'}; padding:6px 16px; border-radius:40px;">${w.status}</span></td><td><button class="btn btn-sm" onclick="toggleOperatorStatus('${w.id}')"><i class="fas fa-toggle-on"></i> toggle</button></td></tr>`).join('');
      document.getElementById('total-operators-count') && (document.getElementById('total-operators-count').innerText = appData.workers.length);
      document.getElementById('active-operators-count') && (document.getElementById('active-operators-count').innerText = appData.workers.filter(w => w.status === 'active').length);
      let morning = appData.workers.filter(w => w.shift === 'Morning').length;
      let afternoon = appData.workers.filter(w => w.shift === 'Afternoon').length;
      let night = appData.workers.filter(w => w.shift === 'Night').length;
      document.getElementById('morning-shift-count') && (document.getElementById('morning-shift-count').innerText = morning);
      document.getElementById('night-shift-count') && (document.getElementById('night-shift-count').innerText = night);
      document.getElementById('morning-badge') && (document.getElementById('morning-badge').innerText = morning);
      document.getElementById('afternoon-badge') && (document.getElementById('afternoon-badge').innerText = afternoon);
      document.getElementById('night-badge') && (document.getElementById('night-badge').innerText = night);
    }

    // ========== SETTINGS PREVIEW ==========
    function previewThresholds() {
      let flowWarn = document.getElementById('settings-flow-warning')?.value || 70;
      let congest = document.getElementById('settings-congestion')?.value || 85;
      document.getElementById('preview-flow').innerText = flowWarn;
      document.getElementById('preview-congestion').innerText = congest + '%';
    }

    // ========== ACTION FUNCTIONS ==========
    function filterAlertsMenu(type) { appData.alertFilter = type; loadAlertsPage(); }
    function sortAlertsByTime() { appData.alerts.sort((a, b) => b.time.localeCompare(a.time)); loadAlertsPage(); }
    function acknowledgeAlert(id) { let a = appData.alerts.find(a => a.id == id); if (a) { a.acknowledged = true; loadAlertsPage(); updateBadges(); } }
    function markAllAlertsRead() { appData.alerts.forEach(a => a.acknowledged = true); loadAlertsPage(); updateBadges(); showNotification('All alerts acknowledged', 'success'); }
    function filterViolations() { loadViolationsPage(); }
    function resolveViolation(id) { let v = appData.violations.find(v => v.id == id); if (v) { v.status = 'resolved'; loadViolationsPage(); showNotification('Violation resolved', 'success'); } }
    function toggleOperatorStatus(id) { let w = appData.workers.find(w => w.id === id); if (w) { w.status = w.status === 'active' ? 'offline' : 'active'; loadWorkersPage(); } }
    function addOperator() {
      let id = document.getElementById('operator-id')?.value || 'OP' + Math.floor(Math.random() * 100);
      let name = document.getElementById('operator-name')?.value || 'New Op';
      let shift = document.getElementById('operator-shift')?.value || 'Morning';
      appData.workers.push({ id, name, zone: appData.sites[appData.currentSite].name, shift, status: 'active' });
      hideModal('add-worker-modal');
      loadWorkersPage();
      showNotification('Operator added', 'success');
    }
    function syncOperatorStatus() { showNotification('Operator sync complete', 'success'); }
    function optimizeShifts() { showNotification('Shift optimization complete ‚Äì coverage balanced', 'success'); }
    function addManualViolation() {
      let plate = document.getElementById('violation-plate')?.value || 'MAN-' + Math.floor(Math.random() * 1000);
      let type = document.getElementById('violation-type-select')?.value || 'Red light';
      let junction = document.getElementById('violation-junction')?.value || 'J5';
      let zonePrefix = appData.sites[appData.currentSite].name.split(' ')[0];
      let newV = { id: appData.violations.length + 1, vehicle: plate, type: type, zone: `${zonePrefix} ${junction}`, confidence: '100', status: 'pending', time: new Date().toLocaleTimeString() };
      appData.violations.unshift(newV);
      appData.alerts.unshift({ id: appData.alerts.length + 1, type: 'warning', message: `Manual: ${type}`, location: `${zonePrefix} ${junction}`, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), acknowledged: false });
      hideModal('add-violation-modal');
      if (document.getElementById('violations-page').classList.contains('active')) loadViolationsPage();
      if (document.getElementById('alerts-page').classList.contains('active')) loadAlertsPage();
      updateBadges();
      showNotification('Incident logged', 'success');
    }
    function exportViolationsCSV() { showNotification('Exporting violations...', 'info'); setTimeout(() => showNotification('CSV ready', 'success'), 1200); }
    function aiScanForViolations() { showNotification('AI scanning ...', 'info'); setTimeout(() => { let newV = { id: appData.violations.length + 1, vehicle: 'NEW-' + Math.floor(Math.random() * 900 + 100), type: 'Speeding', zone: appData.sites[appData.currentSite].name.split(' ')[0] + ' J' + Math.floor(Math.random() * 8 + 1), confidence: '97', status: 'pending', time: new Date().toLocaleTimeString() }; appData.violations.unshift(newV); appData.alerts.unshift({ id: appData.alerts.length + 1, type: 'warning', message: 'AI detected speeding', location: newV.zone, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), acknowledged: false }); if (document.getElementById('violations-page').classList.contains('active')) loadViolationsPage(); if (document.getElementById('alerts-page').classList.contains('active')) loadAlertsPage(); updateBadges(); showNotification('AI scan complete', 'warning'); }, 2000); }
    function fetchAnalyticsData() { showNotification('Analytics refreshed', 'info'); initCharts(); }
    function exportDashboardData() { showNotification('Exporting telemetry...', 'info'); setTimeout(() => showNotification('Export ready', 'success'), 1500); }
    function simulateTrafficFeed() { /* simulation kept minimal */ }
    function toggleAI() { appData.aiEnabled = !appData.aiEnabled; document.getElementById('ai-status') && (document.getElementById('ai-status').innerText = appData.aiEnabled ? 'ON' : 'OFF'); document.getElementById('ai-status-text') && (document.getElementById('ai-status-text').innerText = appData.aiEnabled ? 'Active' : 'Standby'); showNotification(`AI ${appData.aiEnabled ? 'enabled' : 'disabled'}`); }
    function retrainAllModels() { showNotification('Retraining ensemble...', 'info'); setTimeout(() => showNotification('All models updated', 'success'), 2000); }
    function retrainModel(m) { showNotification(`Retraining ${m} model...`, 'info'); }
    function saveSettings() {
      appData.settings.predictionInterval = document.getElementById('settings-prediction-interval')?.value || '15';
      appData.settings.autoResolve = document.getElementById('settings-auto-resolve')?.value || '15';
      appData.settings.sessionTimeout = document.getElementById('settings-session-timeout')?.value || '30';
      appData.settings.auditRetention = document.getElementById('settings-audit')?.value || '90d';
      appData.settings.flowWarning = document.getElementById('settings-flow-warning')?.value || 70;
      appData.settings.congestionThreshold = document.getElementById('settings-congestion')?.value || 85;
      showNotification('Configuration saved successfully', 'success');
    }
    function rotateApiKey() { showNotification('API key rotated', 'warning'); }
    function startRealtime() { setInterval(() => { document.getElementById('last-updated') && (document.getElementById('last-updated').innerText = new Date().toLocaleTimeString()); }, 8000); }
    function updateBadges() { let u = appData.alerts.filter(a => !a.acknowledged).length; document.getElementById('alert-badge') && (document.getElementById('alert-badge').innerText = u); document.getElementById('dashboard-badge') && (document.getElementById('dashboard-badge').innerText = u); }
    function hideModal(id) { document.getElementById(id)?.classList.remove('active'); }
    function showModal(id) { document.getElementById(id)?.classList.add('active'); }
    function showNotification(msg, type = 'info') {
      let n = document.createElement('div');
      n.style.cssText = `position:fixed; top:24px; right:24px; background:${type == 'success' ? '#10b981' : type == 'error' ? '#ef4444' : type == 'warning' ? '#f59e0b' : '#2dd4bf'}; color:white; padding:18px 32px; border-radius:60px; font-weight:600; backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.5); z-index:9999; box-shadow:0 0 40px #2dd4bf80; display:flex; gap:12px; align-items:center;`;
      n.innerHTML = `<i class="fas fa-${type == 'success' ? 'check-circle' : type == 'error' ? 'exclamation-circle' : type == 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i> ${msg}`;
      document.body.appendChild(n);
      setTimeout(() => { n.style.opacity = '0'; n.style.transition = '0.3s'; setTimeout(() => n.remove(), 400); }, 3500);
    }

    // EXPOSE GLOBALS
    window.toggleSidebar = toggleSidebar; window.showPage = showPage; window.handleLogin = handleLogin; window.showAuthTab = showAuthTab; window.handleRegister = handleRegister; window.togglePasswordVisibility = togglePasswordVisibility; window.changeSite = changeSite; window.showLogoutModal = showLogoutModal; window.confirmLogout = confirmLogout; window.toggleAI = toggleAI; window.simulateTrafficFeed = simulateTrafficFeed; window.loadAlertsPage = loadAlertsPage; window.acknowledgeAlert = acknowledgeAlert; window.markAllAlertsRead = markAllAlertsRead; window.filterAlertsMenu = filterAlertsMenu; window.sortAlertsByTime = sortAlertsByTime; window.loadViolationsPage = loadViolationsPage; window.filterViolations = filterViolations; window.resolveViolation = resolveViolation; window.showModal = showModal; window.hideModal = hideModal; window.aiScanForViolations = aiScanForViolations; window.retrainAllModels = retrainAllModels; window.retrainModel = retrainModel; window.exportDashboardData = exportDashboardData; window.fetchAnalyticsData = fetchAnalyticsData; window.addOperator = addOperator; window.toggleOperatorStatus = toggleOperatorStatus; window.syncOperatorStatus = syncOperatorStatus; window.optimizeShifts = optimizeShifts; window.addManualViolation = addManualViolation; window.exportViolationsCSV = exportViolationsCSV; window.loadMonitoringPage = loadMonitoringPage; window.saveSettings = saveSettings; window.rotateApiKey = rotateApiKey; window.previewThresholds = previewThresholds;
  </script>
</body>
</html>